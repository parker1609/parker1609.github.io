<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항 | Parker Blog</title><meta name=keywords content="Spring Boot,JPA,PostgreSQL"><meta name=description content="해당 글의 예제 코드는 이 링크를 참조해주세요.
JPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.
1. @GeneratedValue 사용하지 않는 경우 @GeneratedValue 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.
ids for this class must be manually assigned before calling save() 엔티티를 저장하는 save() 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다."><meta name=author content="parker1609"><link rel=canonical href=https://parker1609.github.io/post/spring-boot-and-jpa-and-postgresql-generating-primary-key/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://parker1609.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://parker1609.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://parker1609.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://parker1609.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://parker1609.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항"><meta property="og:description" content="해당 글의 예제 코드는 이 링크를 참조해주세요.
JPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.
1. @GeneratedValue 사용하지 않는 경우 @GeneratedValue 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.
ids for this class must be manually assigned before calling save() 엔티티를 저장하는 save() 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다."><meta property="og:type" content="article"><meta property="og:url" content="https://parker1609.github.io/post/spring-boot-and-jpa-and-postgresql-generating-primary-key/"><meta property="og:image" content="https://parker1609.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-06-01T10:06:13+09:00"><meta property="article:modified_time" content="2022-06-01T10:06:13+09:00"><meta property="og:site_name" content="Parker Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://parker1609.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항"><meta name=twitter:description content="해당 글의 예제 코드는 이 링크를 참조해주세요.
JPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.
1. @GeneratedValue 사용하지 않는 경우 @GeneratedValue 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.
ids for this class must be manually assigned before calling save() 엔티티를 저장하는 save() 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://parker1609.github.io/post/"},{"@type":"ListItem","position":2,"name":"[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항","item":"https://parker1609.github.io/post/spring-boot-and-jpa-and-postgresql-generating-primary-key/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항","name":"[Spring Boot \u002b JPA \u002b PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항","description":"해당 글의 예제 코드는 이 링크를 참조해주세요.\nJPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.\n1. @GeneratedValue 사용하지 않는 경우 @GeneratedValue 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.\nids for this class must be manually assigned before calling save() 엔티티를 저장하는 save() 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다.","keywords":["Spring Boot","JPA","PostgreSQL"],"articleBody":" 해당 글의 예제 코드는 이 링크를 참조해주세요.\nJPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.\n1. @GeneratedValue 사용하지 않는 경우 @GeneratedValue 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.\nids for this class must be manually assigned before calling save() 엔티티를 저장하는 save() 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다.\nid에 넣을 값은 DB의 PK 속성에 알맞는 값을 사용해야 한다.\nDB의 PK(Primary Key) 제약조건\n테이블당 오직 하나의 필드에만 설정가능하다. 중복되지 않는 고유한 값이어야 한다. NULL 값이 아니다. 주민등록 번호나 휴대폰 번호와 같은 자연키로는 PK 제약조건을 만족하기 어렵다. (해당 시점에는 만족하더라도, 시간이 지나면서 만족하지 않는 경우가 많이 생긴다.)\n따라서, 자연키 대신으로 UUID, 랜덤 값, 자동증가 값 등을 사용할 수 있다. 하지만, 대부분 직접하기 보다는 DB에 이러한 키 생성을 맡긴다. (@GeneratedValue 사용)\n예제 UUID를 사용하는 예제를 잠깐 살펴보자.\n@NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class MemberUUIDKey implements Serializable { private static final long serialVersionUID = 1L; @Id private UUID id; private String name; private String email; public MemberUUIDKey(UUID id, String name, String email) { this.id = id; this.name = name; this.email = email; } } 아래 테스트를 동작시켜보자.\n@Test @Rollback(value = false) // commit 실행으로 insert 쿼리까지 보기 위함. void save() { // id = null 삽입 시, ids for this class must be manually assigned before calling save() 에러 발생 MemberUUIDKey member = new MemberUUIDKey(UUID.randomUUID(), \"parker\", \"parker@gmail.com\"); MemberUUIDKey saved = memberUUIDKeyRepository.save(member); assertThat(saved).isNotNull(); log.info(\"{}\", saved); } 테스트 실행 결과에서 SQL은 다음과 같은 순서로 동작한다.\n# 테스트 실행마다, 테이블을 새로 생성한다. create table memberuuidkey ( id uuid not null, email varchar(255), name varchar(255), primary key (id) ) # log.info에서 saved를 먼저 조회한다.(영속성 컨텍스트에서 조회?) select memberuuid0_.id as id1_4_0_, memberuuid0_.email as email2_4_0_, memberuuid0_.name as name3_4_0_ from memberuuidkey memberuuid0_ where memberuuid0_.id=? # Commit 시점에 insert 쿼리가 날라간다. insert into memberuuidkey (email, name, id) values (?, ?, ?) 2. @GeneratedValue 사용하는 경우 2.1. @GeneratedValue(strategy = GenerationType.TABLE) (비권장) 키 설정을 위한 테이블 생성 기본 설정으로 hibernate_sequences 테이블 생성 @SequenceGenerator 로 키 설정 테이블 설정 가능 단점 키 설정을 위한 새로운 테이블이 생성되어야 함. 최적화하기 힘듦. (키 설정을 위한 테이블을 생성하기 보다는 DB마다 최적화된 방법을 사용하는 것이 좋다.) 엔티티\n@NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class Member { @Id @GeneratedValue(strategy = GenerationType.TABLE) private Long id; private String name; private String email; public Member(Long id, String name, String email) { this.id = id; this.name = name; this.email = email; } } 테스트 코드 (모든 전략에서 같은 테스트 코드이므로, 아래 전략부터는 생략함.)\n@Test @Rollback(value = false) // commit 실행으로 insert 쿼리까지 보기 위함. void save() { Member member = new Member(null, \"parker\", \"parker@gmail.com\"); Member saved = memberRepository.save(member); assertThat(saved).isNotNull(); log.info(\"{}\", saved); } JPA 동작 순서\n# 키 설정용 테이블 생성 create table hibernate_sequences ( sequence_name varchar(255) not null, next_val int8, primary key (sequence_name) ) # 기본값으로 0 세팅 insert into hibernate_sequences(sequence_name, next_val) values ('default',0) # Member 테이블 생성 create table member ( id int8 not null, email varchar(255), name varchar(255), primary key (id) ) # 키 설정 테이블에서 id로 사용할 값 조회 select tbl.next_val from hibernate_sequences tbl where tbl.sequence_name=? for update of tbl # 다음 사용을 위해 id 업데이트 update hibernate_sequences set next_val=? where next_val=? and sequence_name=? # log.info 조회 결과 # Commit 시점에 insert 쿼리가 날라간다. insert into memberuuidkey (email, name, id) values (?, ?, ?) 직접 DB툴에서 동작시켜보면, 위처럼 테이블이 생성된 것이 보인다.\n2.2. @GeneratedValue(strategy = GenerationType.IDENTITY) (권장) 키 생성을 DB에 위임한다. 이 전략에서 실제 키 값을 알기위해서는 DB에 실제 매핑된 시점(Commit 이후)에만 알 수 있다. 따라서, persist() 메서드 호출 시점에 바로 insert 쿼리가 발생한다. (원래는 commit 시점에 보낸다.) JPA에서는 원래 commit 시점에 모아서 변경 쿼리를 보내는데, 이 이점을 사용할 수는 없다. (큰 단점은 아니다.) @NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class Member { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; private String name; private String email; public Member(Long id, String name, String email) { this.id = id; this.name = name; this.email = email; } } create table member ( id int8 generated by default as identity, email varchar(255), name varchar(255), primary key (id) ) # save() 시점에 바로 insert 쿼리 발생 insert into memberuuidkey (email, name) values (?, ?) # log.info 조회에서 해당 member의 id 값 조회 select currval('member_id_seq') member_id_seq 은 테이블은 아니고, PostgreSQL에서 자체적으로 만든 Sequence이다.\nSequence의 이름 생성 방식은 {테이블 이름}_{id 컬럼 이름}_seq 이다. 2.2.1 Sequence 길이 주의사항 PostgreSQL에서 테이블 또는 Sequence 이름 길이는 최대 영문 63글자(63bytes) 이내이다. (참고 링크)\n위를 초과하면 최대길이를 넘어간 부분은 생략하여 생성하게 된다.\n하지만, 여기서 더 주의할 점은 Spring Boot의 설정 hibernate.temp.use_jdbc_metadata_defaults 값은 기본적으로 true로 설정되어 있는데, 이 설정은 JDBC 환경구성을 하는 과정에서 기본 메타 데이터를 사용할지에 대한 설정이다. 이를 사용할 때, 데이터베이스 자체와는 다른 JDBC 자체 설정들이 포함하여 기존의 생각과 다르게 동작할 때가 많다.\n여기서는 Sequence의 최대길이가 넘어가는 경우에 위 설정이 true인 경우에는 생략된 시퀀스도 인식을 하지만, false인 경우에는 인식을 하지 못한다.\n아래 예제를 살펴보자.\n@NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class ThisIsVeryLongNameTable { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Column(name = \"this_is_very_long_long_long_long_id\", updatable = false, nullable = false) private Long id; private String data; public ThisIsVeryLongNameTable(Long id, String data) { this.id = id; this.data = data; } } 위 엔티티에서 Sequence의 이름은 this_is_very_long_name_table_this_is_very_long_long_long_long_id_seq 가 될 것이며, 총 길이는 68bytes이다.\n따라서 63bytes가 넘어간 부분은 아래와 같이 생략해서 시퀀스가 생성된다.\nhibernate.temp.use_jdbc_metadata_defaults=true 인 경우 아래 테스트를 동작시켜보자.\n@Test void save() { ThisIsVeryLongNameTable table = new ThisIsVeryLongNameTable(null, \"TEMP\"); ThisIsVeryLongNameTable saved = thisIsVeryLongNameTableRepository.save(table); assertThat(saved).isNotNull(); log.info(\"{}\", saved); } 정상적으로 통과하는 것을 볼 수 있다.\nhibernate.temp.use_jdbc_metadata_defaults=false 로 변경해서 다시 한 번 테스트를 돌려보자.\nERROR: relation \"this_is_very_long_name_table_this_is_very_long_long_long_long_i\" does not exist 위 에러가 발생한다.\nselect currval('this_is_very_long_name_table_this_is_very_long_long_long_long_id_seq') 위 쿼리로 풀 네임의 Sequence를 조회하려고 하지만, 실제로는 생략된 시퀀스가 생성되어 있어 찾지 못해 에러가 발생한다.\n(hibernate.temp.use_jdbc_metadata_defaults=true 인 경우, 위 select currval... 쿼리도 생략이 되는데… 쿼리 자체를 내부적으로 다르게 호출하는 듯하기도 하다.)\n결론은 위 설정이 false가 필요하다면, 테이블과 id의 컬럼 길이에 대해서 신경을 써주어야 한다.\n2.3. @GeneratedValue(strategy = GenerationType.SEQUENCE) DB의 Sequence Object를 활용한다. PostgreSQL은 hibernate_sequence 이름의 시퀀스가 생성된다. TABLE 전략과 비슷한 이름으로 생성되지만, 위는 테이블이 아닌 시퀀스에 생성된다. @SequenceGenerator 어노테이션으로 설정을 변경할 수 있다. id가 필요한 경우, 해당 시퀀스에서 조회를 해야 해서 id 조회를 위한 쿼리가 따로 발생한다. allocationSize 설정을 1보다 큰 값으로 설정하면, 쿼리가 매번 나가지 않도록 최적화할 수 있다. (동시성도 모두 DB 자체에서 처리되어 있다.) allocationSize 는 50 ~ 100 사이를 권장한다. @NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class Member { @Id @GeneratedValue(strategy = GenerationType.SEQUENCE) private Long id; private String name; private String email; public Member(Long id, String name, String email) { this.id = id; this.name = name; this.email = email; } } create sequence hibernate_sequence start 1 increment 1 create table member ( id int8 not null, email varchar(255), name varchar(255), primary key (id) ) select nextval ('hibernate_sequence') # log.info로 member 조회 완료 # Commit 시점에 insert 쿼리가 날라간다. insert into memberuuidkey (email, name, id) values (?, ?, ?) 2.4. @GeneratedValue(strategy = GenerationType.AUTO) JPA에서 DB에 따라 자동으로 키 생성 전략을 선택한다. hibernate.id.new_generator_mappings 의 설정에 따라 선택 기준이 달라진다. 이 설정의 기본값은 Spring boot 또는 하이버네이트 버전에 따라 다르다. true: 해당 DB에서 Sequence를 지원하면 SEQUENCE 전략을 사용하고, 지원하지 않으면 TABLE 전략을 사용한다. (SequenceStyleGenerator 사용) falase: IDENTITY 전략 또는 SEQUENCE 전략을 사용 (NativeGenerator 사용) 하이버네이트 5.4 버전 문서 참고 스프링 부트 2.0 JPA Auto-configuration의 변화 PostgreSQL에서는 SEQUENCE 전략을 사용함. @NoArgsConstructor(access = AccessLevel.PROTECTED) @Getter @ToString @Entity public class Member { @Id @GeneratedValue(strategy = GenerationType.AUTO) private Long id; private String name; private String email; public Member(Long id, String name, String email) { this.id = id; this.name = name; this.email = email; } } create sequence hibernate_sequence start 1 increment 1 create table member ( id int8 not null, email varchar(255), name varchar(255), primary key (id) ) select nextval ('hibernate_sequence') # log.info로 member 조회 완료 # Commit 시점에 insert 쿼리가 날라간다. insert into memberuuidkey (email, name, id) values (?, ?, ?) 참고자료 자바 ORM 표준 JPA 프로그래밍 (책 및 인프런 강의) https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html https://browndwarf.tistory.com/29 https://gmlwjd9405.github.io/2019/08/12/primary-key-mapping.html https://kwonnam.pe.kr/wiki/java/hibernate/configuration ","wordCount":"1291","inLanguage":"en","datePublished":"2022-06-01T10:06:13+09:00","dateModified":"2022-06-01T10:06:13+09:00","author":{"@type":"Person","name":"parker1609"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://parker1609.github.io/post/spring-boot-and-jpa-and-postgresql-generating-primary-key/"},"publisher":{"@type":"Organization","name":"Parker Blog","logo":{"@type":"ImageObject","url":"https://parker1609.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://parker1609.github.io/ accesskey=h title="파커 블로그 (Alt + H)"><img src=https://parker1609.github.io/apple-touch-icon.png alt aria-label=logo height=35>파커 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://parker1609.github.io/ title=Home><span>Home</span></a></li><li><a href=https://parker1609.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://parker1609.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://parker1609.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://parker1609.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://parker1609.github.io/post/>Posts</a></div><h1 class=post-title>[Spring Boot + JPA + PostgreSQL] 다양한 기본키(PK) 생성 방식과 주의사항</h1><div class=post-meta><span title='2022-06-01 10:06:13 +0900 KST'>June 1, 2022</span>&nbsp;·&nbsp;parker1609</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-generatedvalue-%ec%82%ac%ec%9a%a9%ed%95%98%ec%a7%80-%ec%95%8a%eb%8a%94-%ea%b2%bd%ec%9a%b0 aria-label="1. @GeneratedValue 사용하지 않는 경우">1. <code>@GeneratedValue</code> 사용하지 않는 경우</a><ul><li><a href=#%ec%98%88%ec%a0%9c aria-label=예제>예제</a></li></ul></li><li><a href=#2-generatedvalue-%ec%82%ac%ec%9a%a9%ed%95%98%eb%8a%94-%ea%b2%bd%ec%9a%b0 aria-label="2. @GeneratedValue 사용하는 경우">2. <code>@GeneratedValue</code> 사용하는 경우</a><ul><li><a href=#21-generatedvaluestrategy--generationtypetable-%eb%b9%84%ea%b6%8c%ec%9e%a5 aria-label="2.1. @GeneratedValue(strategy = GenerationType.TABLE) (비권장)">2.1. <code>@GeneratedValue(strategy = GenerationType.TABLE)</code> (비권장)</a></li><li><a href=#22-generatedvaluestrategy--generationtypeidentity-%ea%b6%8c%ec%9e%a5 aria-label="2.2. @GeneratedValue(strategy = GenerationType.IDENTITY) (권장)">2.2. <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> (권장)</a><ul><li><a href=#221-sequence-%ea%b8%b8%ec%9d%b4-%ec%a3%bc%ec%9d%98%ec%82%ac%ed%95%ad aria-label="2.2.1 Sequence 길이 주의사항">2.2.1 Sequence 길이 주의사항</a></li></ul></li><li><a href=#23-generatedvaluestrategy--generationtypesequence aria-label="2.3. @GeneratedValue(strategy = GenerationType.SEQUENCE)">2.3. <code>@GeneratedValue(strategy = GenerationType.SEQUENCE)</code></a></li><li><a href=#24-generatedvaluestrategy--generationtypeauto aria-label="2.4. @GeneratedValue(strategy = GenerationType.AUTO)">2.4. <code>@GeneratedValue(strategy = GenerationType.AUTO)</code></a></li></ul></li><li><a href=#%ec%b0%b8%ea%b3%a0%ec%9e%90%eb%a3%8c aria-label=참고자료>참고자료</a></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글의 예제 코드는 <a href=https://github.com/parker1609/my-articles/tree/main/JPA/spring-jpa-postgresql-pk>이 링크</a>를 참조해주세요.</p></blockquote><p>JPA에서 엔티티의 PK 생성 방법은 여러가지가 존재합니다. JPA에서 제공해주는 방식과 이를 PostgreSQL에서 사용했을 때, 어떻게 동작하는지 그리고 어떤 주의할 사항이 있는지 살펴보겠습니다.</p><h1 id=1-generatedvalue-사용하지-않는-경우>1. <code>@GeneratedValue</code> 사용하지 않는 경우<a hidden class=anchor aria-hidden=true href=#1-generatedvalue-사용하지-않는-경우>#</a></h1><p><code>@GeneratedValue</code> 어노테이션을 사용하지 않는 경우, 반드시 엔티티를 생성할 때, 직접 id 값을 지정해주어야 한다. 그렇지 않은 경우, 아래와 같은 에러가 발생한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ids <span class=k>for</span> this class must be manually assigned before calling save<span class=o>()</span>
</span></span></code></pre></div><p>엔티티를 저장하는 <code>save()</code> 메서드 호출 전에 id값이 명시되어 있어야 한다는 오류이다.</p><p>id에 넣을 값은 DB의 PK 속성에 알맞는 값을 사용해야 한다.</p><blockquote><p>DB의 PK(Primary Key) 제약조건</p><ol><li>테이블당 오직 하나의 필드에만 설정가능하다.</li><li><strong>중복되지 않는 고유한 값이어야 한다.</strong></li><li>NULL 값이 아니다.</li></ol></blockquote><p>주민등록 번호나 휴대폰 번호와 같은 자연키로는 PK 제약조건을 만족하기 어렵다. (해당 시점에는 만족하더라도, 시간이 지나면서 만족하지 않는 경우가 많이 생긴다.)</p><p>따라서, 자연키 대신으로 UUID, 랜덤 값, 자동증가 값 등을 사용할 수 있다. 하지만, 대부분 직접하기 보다는 DB에 이러한 키 생성을 맡긴다. (<code>@GeneratedValue</code> 사용)</p><h2 id=예제>예제<a hidden class=anchor aria-hidden=true href=#예제>#</a></h2><p>UUID를 사용하는 예제를 잠깐 살펴보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MemberUUIDKey</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>serialVersionUID</span> <span class=o>=</span> <span class=mi>1L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>MemberUUIDKey</span><span class=o>(</span><span class=n>UUID</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>email</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>아래 테스트를 동작시켜보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@Rollback</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=kc>false</span><span class=o>)</span> <span class=c1>// commit 실행으로 insert 쿼리까지 보기 위함.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>save</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// id = null 삽입 시, ids for this class must be manually assigned before calling save() 에러 발생
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>MemberUUIDKey</span> <span class=n>member</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MemberUUIDKey</span><span class=o>(</span><span class=n>UUID</span><span class=o>.</span><span class=na>randomUUID</span><span class=o>(),</span> <span class=s>&#34;parker&#34;</span><span class=o>,</span> <span class=s>&#34;parker@gmail.com&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>MemberUUIDKey</span> <span class=n>saved</span> <span class=o>=</span> <span class=n>memberUUIDKeyRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>saved</span><span class=o>).</span><span class=na>isNotNull</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>saved</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>테스트 실행 결과에서 SQL은 다음과 같은 순서로 동작한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>테스트</span><span class=w> </span><span class=err>실행마다</span><span class=p>,</span><span class=w> </span><span class=err>테이블을</span><span class=w> </span><span class=err>새로</span><span class=w> </span><span class=err>생성한다</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>id</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=n>info</span><span class=err>에서</span><span class=w> </span><span class=n>saved</span><span class=err>를</span><span class=w> </span><span class=err>먼저</span><span class=w> </span><span class=err>조회한다</span><span class=p>.(</span><span class=err>영속성</span><span class=w> </span><span class=err>컨텍스트에서</span><span class=w> </span><span class=err>조회</span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memberuuid0_</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id1_4_0_</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memberuuid0_</span><span class=p>.</span><span class=n>email</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>email2_4_0_</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memberuuid0_</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>name3_4_0_</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memberuuidkey</span><span class=w> </span><span class=n>memberuuid0_</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memberuuid0_</span><span class=p>.</span><span class=n>id</span><span class=o>=?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=k>Commit</span><span class=w> </span><span class=err>시점에</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=err>쿼리가</span><span class=w> </span><span class=err>날라간다</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h1 id=2-generatedvalue-사용하는-경우>2. <code>@GeneratedValue</code> 사용하는 경우<a hidden class=anchor aria-hidden=true href=#2-generatedvalue-사용하는-경우>#</a></h1><h2 id=21-generatedvaluestrategy--generationtypetable-비권장>2.1. <code>@GeneratedValue(strategy = GenerationType.TABLE)</code> (비권장)<a hidden class=anchor aria-hidden=true href=#21-generatedvaluestrategy--generationtypetable-비권장>#</a></h2><ul><li>키 설정을 위한 테이블 생성<ul><li>기본 설정으로 hibernate_sequences 테이블 생성</li><li><code>@SequenceGenerator</code> 로 키 설정 테이블 설정 가능</li></ul></li><li>단점<ul><li>키 설정을 위한 새로운 테이블이 생성되어야 함.</li><li>최적화하기 힘듦. (키 설정을 위한 테이블을 생성하기 보다는 DB마다 최적화된 방법을 사용하는 것이 좋다.)</li></ul></li></ul><p>엔티티</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Member</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GeneratedValue</span><span class=o>(</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>GenerationType</span><span class=o>.</span><span class=na>TABLE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Member</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>email</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>테스트 코드 (모든 전략에서 같은 테스트 코드이므로, 아래 전략부터는 생략함.)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=nd>@Rollback</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=kc>false</span><span class=o>)</span> <span class=c1>// commit 실행으로 insert 쿼리까지 보기 위함.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>save</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Member</span> <span class=n>member</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Member</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=s>&#34;parker&#34;</span><span class=o>,</span> <span class=s>&#34;parker@gmail.com&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Member</span> <span class=n>saved</span> <span class=o>=</span> <span class=n>memberRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>saved</span><span class=o>).</span><span class=na>isNotNull</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>saved</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>JPA 동작 순서</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>키</span><span class=w> </span><span class=err>설정용</span><span class=w> </span><span class=err>테이블</span><span class=w> </span><span class=err>생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>hibernate_sequences</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>sequence_name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>next_val</span><span class=w> </span><span class=nb>int8</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>sequence_name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>기본값으로</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=err>세팅</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>hibernate_sequences</span><span class=p>(</span><span class=n>sequence_name</span><span class=p>,</span><span class=w> </span><span class=n>next_val</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;default&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=err>테이블</span><span class=w> </span><span class=err>생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>id</span><span class=w> </span><span class=nb>int8</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>키</span><span class=w> </span><span class=err>설정</span><span class=w> </span><span class=err>테이블에서</span><span class=w> </span><span class=n>id</span><span class=err>로</span><span class=w> </span><span class=err>사용할</span><span class=w> </span><span class=err>값</span><span class=w> </span><span class=err>조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tbl</span><span class=p>.</span><span class=n>next_val</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hibernate_sequences</span><span class=w> </span><span class=n>tbl</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tbl</span><span class=p>.</span><span class=n>sequence_name</span><span class=o>=?</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>of</span><span class=w> </span><span class=n>tbl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>다음</span><span class=w> </span><span class=err>사용을</span><span class=w> </span><span class=err>위해</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=err>업데이트</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hibernate_sequences</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>next_val</span><span class=o>=?</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>next_val</span><span class=o>=?</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>and</span><span class=w> </span><span class=n>sequence_name</span><span class=o>=?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=n>info</span><span class=w> </span><span class=err>조회</span><span class=w> </span><span class=err>결과</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=k>Commit</span><span class=w> </span><span class=err>시점에</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=err>쿼리가</span><span class=w> </span><span class=err>날라간다</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=https://user-images.githubusercontent.com/34755287/229325228-08308272-e5fb-4a22-95d7-6b8f372d0fe0.png alt=result-of-creating-table></p><p>직접 DB툴에서 동작시켜보면, 위처럼 테이블이 생성된 것이 보인다.</p><h2 id=22-generatedvaluestrategy--generationtypeidentity-권장>2.2. <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> (권장)<a hidden class=anchor aria-hidden=true href=#22-generatedvaluestrategy--generationtypeidentity-권장>#</a></h2><ul><li>키 생성을 DB에 위임한다.</li><li>이 전략에서 실제 키 값을 알기위해서는 DB에 실제 매핑된 시점(Commit 이후)에만 알 수 있다.<ul><li>따라서, <code>persist()</code> 메서드 호출 시점에 바로 <code>insert</code> 쿼리가 발생한다. (원래는 commit 시점에 보낸다.)</li><li>JPA에서는 원래 commit 시점에 모아서 변경 쿼리를 보내는데, 이 이점을 사용할 수는 없다. (큰 단점은 아니다.)</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Member</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GeneratedValue</span><span class=o>(</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>GenerationType</span><span class=o>.</span><span class=na>IDENTITY</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Member</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>email</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>id</span><span class=w> </span><span class=nb>int8</span><span class=w> </span><span class=k>generated</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>identity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>email</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>save</span><span class=p>()</span><span class=w> </span><span class=err>시점에</span><span class=w> </span><span class=err>바로</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=err>쿼리</span><span class=w> </span><span class=err>발생</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=n>info</span><span class=w> </span><span class=err>조회에서</span><span class=w> </span><span class=err>해당</span><span class=w> </span><span class=n>member</span><span class=err>의</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=err>값</span><span class=w> </span><span class=err>조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>currval</span><span class=p>(</span><span class=s1>&#39;member_id_seq&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><code>member_id_seq</code> 은 테이블은 아니고, PostgreSQL에서 자체적으로 만든 Sequence이다.</p><ul><li>Sequence의 이름 생성 방식은 <code>{테이블 이름}_{id 컬럼 이름}_seq</code> 이다.</li></ul><h3 id=221-sequence-길이-주의사항>2.2.1 Sequence 길이 주의사항<a hidden class=anchor aria-hidden=true href=#221-sequence-길이-주의사항>#</a></h3><p>PostgreSQL에서 테이블 또는 Sequence 이름 길이는 최대 영문 63글자(63bytes) 이내이다. (<a href=https://stackoverflow.com/questions/27865770/how-long-can-postgresql-table-names-be>참고 링크</a>)</p><p><strong>위를 초과하면 최대길이를 넘어간 부분은 생략하여 생성하게 된다.</strong></p><p>하지만, 여기서 더 주의할 점은 Spring Boot의 설정 <code>hibernate.temp.use_jdbc_metadata_defaults</code> 값은 기본적으로 true로 설정되어 있는데, 이 설정은 JDBC 환경구성을 하는 과정에서 기본 메타 데이터를 사용할지에 대한 설정이다. 이를 사용할 때, 데이터베이스 자체와는 다른 JDBC 자체 설정들이 포함하여 기존의 생각과 다르게 동작할 때가 많다.</p><p>여기서는 Sequence의 최대길이가 넘어가는 경우에 위 설정이 <strong>true인 경우에는 생략된 시퀀스도 인식을 하지만, false인 경우에는 인식을 하지 못한다.</strong></p><p>아래 예제를 살펴보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThisIsVeryLongNameTable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GeneratedValue</span><span class=o>(</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>GenerationType</span><span class=o>.</span><span class=na>IDENTITY</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Column</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=s>&#34;this_is_very_long_long_long_long_id&#34;</span><span class=o>,</span> <span class=n>updatable</span> <span class=o>=</span> <span class=kc>false</span><span class=o>,</span> <span class=n>nullable</span> <span class=o>=</span> <span class=kc>false</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>ThisIsVeryLongNameTable</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>위 엔티티에서 Sequence의 이름은 <code>this_is_very_long_name_table_this_is_very_long_long_long_long_id_seq</code> 가 될 것이며, 총 길이는 68bytes이다.</p><p>따라서 63bytes가 넘어간 부분은 아래와 같이 생략해서 시퀀스가 생성된다.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/34755287/229325173-e55e1142-3458-4549-ba10-f7387a783ac1.png alt=result-of-creating-primary-key></p><p><code>hibernate.temp.use_jdbc_metadata_defaults=true</code> 인 경우 아래 테스트를 동작시켜보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>save</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ThisIsVeryLongNameTable</span> <span class=n>table</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThisIsVeryLongNameTable</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=s>&#34;TEMP&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ThisIsVeryLongNameTable</span> <span class=n>saved</span> <span class=o>=</span> <span class=n>thisIsVeryLongNameTableRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>table</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>saved</span><span class=o>).</span><span class=na>isNotNull</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>saved</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>정상적으로 통과하는 것을 볼 수 있다.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/34755287/229325244-d4cd6ae4-b65e-4795-b527-00c74cfdd00c.png alt=result-of-test1></p><p><code>hibernate.temp.use_jdbc_metadata_defaults=false</code> 로 변경해서 다시 한 번 테스트를 돌려보자.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/34755287/229325257-c281c5d6-4aaa-4afa-9861-57e890159ded.png alt=result-of-test2></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ERROR: relation <span class=s2>&#34;this_is_very_long_name_table_this_is_very_long_long_long_long_i&#34;</span> does not exist
</span></span></code></pre></div><p>위 에러가 발생한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>currval</span><span class=p>(</span><span class=s1>&#39;this_is_very_long_name_table_this_is_very_long_long_long_long_id_seq&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>위 쿼리로 풀 네임의 Sequence를 조회하려고 하지만, 실제로는 생략된 시퀀스가 생성되어 있어 찾지 못해 에러가 발생한다.</p><p>(<code>hibernate.temp.use_jdbc_metadata_defaults=true</code> 인 경우, 위 <code>select currval...</code> 쿼리도 생략이 되는데… 쿼리 자체를 내부적으로 다르게 호출하는 듯하기도 하다.)</p><p>결론은 위 설정이 false가 필요하다면, 테이블과 id의 컬럼 길이에 대해서 신경을 써주어야 한다.</p><h2 id=23-generatedvaluestrategy--generationtypesequence>2.3. <code>@GeneratedValue(strategy = GenerationType.SEQUENCE)</code><a hidden class=anchor aria-hidden=true href=#23-generatedvaluestrategy--generationtypesequence>#</a></h2><ul><li>DB의 Sequence Object를 활용한다.<ul><li>PostgreSQL은 <code>hibernate_sequence</code> 이름의 시퀀스가 생성된다.</li><li>TABLE 전략과 비슷한 이름으로 생성되지만, 위는 테이블이 아닌 시퀀스에 생성된다.</li><li><code>@SequenceGenerator</code> 어노테이션으로 설정을 변경할 수 있다.</li></ul></li><li>id가 필요한 경우, 해당 시퀀스에서 조회를 해야 해서 id 조회를 위한 쿼리가 따로 발생한다.<ul><li><code>allocationSize</code> 설정을 1보다 큰 값으로 설정하면, 쿼리가 매번 나가지 않도록 최적화할 수 있다. (동시성도 모두 DB 자체에서 처리되어 있다.)</li><li><code>allocationSize</code> 는 50 ~ 100 사이를 권장한다.</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Member</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GeneratedValue</span><span class=o>(</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>GenerationType</span><span class=o>.</span><span class=na>SEQUENCE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Member</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>email</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=n>sequence</span><span class=w> </span><span class=n>hibernate_sequence</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>increment</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>id</span><span class=w> </span><span class=nb>int8</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>email</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>nextval</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;hibernate_sequence&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=n>info</span><span class=err>로</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=err>조회</span><span class=w> </span><span class=err>완료</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=k>Commit</span><span class=w> </span><span class=err>시점에</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=err>쿼리가</span><span class=w> </span><span class=err>날라간다</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=24-generatedvaluestrategy--generationtypeauto>2.4. <code>@GeneratedValue(strategy = GenerationType.AUTO)</code><a hidden class=anchor aria-hidden=true href=#24-generatedvaluestrategy--generationtypeauto>#</a></h2><ul><li>JPA에서 DB에 따라 자동으로 키 생성 전략을 선택한다.</li><li><code>hibernate.id.new_generator_mappings</code> 의 설정에 따라 선택 기준이 달라진다.<ul><li>이 설정의 기본값은 Spring boot 또는 하이버네이트 버전에 따라 다르다.</li><li><code>true</code>: 해당 DB에서 Sequence를 지원하면 <code>SEQUENCE</code> 전략을 사용하고, 지원하지 않으면 <code>TABLE</code> 전략을 사용한다. (<code>SequenceStyleGenerator</code> 사용)</li><li><code>falase</code>: <code>IDENTITY</code> 전략 또는 <code>SEQUENCE</code> 전략을 사용 (<code>NativeGenerator</code> 사용)</li><li><a href=https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-auto>하이버네이트 5.4 버전 문서 참고</a></li><li><a href=https://www.popit.kr/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8-2-0-jpa-auto-configuration%EC%9D%98-%EB%B3%80%ED%99%94/>스프링 부트 2.0 JPA Auto-configuration의 변화</a></li></ul></li><li><strong>PostgreSQL에서는</strong> <code>SEQUENCE</code> <strong>전략을 사용함.</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span><span class=o>(</span><span class=n>access</span> <span class=o>=</span> <span class=n>AccessLevel</span><span class=o>.</span><span class=na>PROTECTED</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span>
</span></span><span class=line><span class=cl><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Member</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GeneratedValue</span><span class=o>(</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>GenerationType</span><span class=o>.</span><span class=na>AUTO</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Member</span><span class=o>(</span><span class=n>Long</span> <span class=n>id</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>email</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=n>sequence</span><span class=w> </span><span class=n>hibernate_sequence</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>increment</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>id</span><span class=w> </span><span class=nb>int8</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>email</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nextval</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;hibernate_sequence&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=n>info</span><span class=err>로</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=err>조회</span><span class=w> </span><span class=err>완료</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=k>Commit</span><span class=w> </span><span class=err>시점에</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=err>쿼리가</span><span class=w> </span><span class=err>날라간다</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>memberuuidkey</span><span class=w> </span><span class=p>(</span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h1 id=참고자료>참고자료<a hidden class=anchor aria-hidden=true href=#참고자료>#</a></h1><ul><li>자바 ORM 표준 JPA 프로그래밍 (책 및 인프런 강의)</li><li><a href=https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html>https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html</a></li><li><a href=https://browndwarf.tistory.com/29>https://browndwarf.tistory.com/29</a></li><li><a href=https://gmlwjd9405.github.io/2019/08/12/primary-key-mapping.html>https://gmlwjd9405.github.io/2019/08/12/primary-key-mapping.html</a></li><li><a href=https://kwonnam.pe.kr/wiki/java/hibernate/configuration>https://kwonnam.pe.kr/wiki/java/hibernate/configuration</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://parker1609.github.io/tags/spring-boot/>Spring Boot</a></li><li><a href=https://parker1609.github.io/tags/jpa/>JPA</a></li><li><a href=https://parker1609.github.io/tags/postgresql/>PostgreSQL</a></li></ul><nav class=paginav><a class=prev href=https://parker1609.github.io/post/network-basic-tcp-and-ip/><span class=title>« Prev</span><br><span>[개발자가 알아야 할 네트워크 기초] TCP/IP 개요</span></a>
<a class=next href=https://parker1609.github.io/post/cheat-sheet-git-commands/><span class=title>Next »</span><br><span>자주 사용하는 git 명령어 모음</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=parker1609/parker1609.github.io data-repo-id=R_kgDOI_VMsw data-category=Announcements data-category-id=DIC_kwDOI_VMs84CUTZR data-mapping=og:title data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://parker1609.github.io/>Parker Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>